# ç½‘ç«™é˜²æŠ¤æ•™ç¨‹ï¼šé˜²æ­¢æ”»å‡»ä¸æµé‡å†²å‡»

> **ç¯å¢ƒ**: OpenResty + 1Panel + Fail2ban
> **ç‰¹ç‚¹**: 1Panel ç®€åŒ–ç®¡ç† + OpenResty å¼ºå¤§æ‰©å±•èƒ½åŠ›

---

## ğŸ¯ ä¸€ã€å¿«é€Ÿå¼€å§‹ï¼ˆæ­£ç¡®çš„é…ç½®è·¯å¾„ï¼‰

### 1.1 1Panel å®é™…åŠŸèƒ½è¯´æ˜

**æ³¨æ„**: 1Panel æ²¡æœ‰"å®‰å…¨"æ ‡ç­¾å’Œ"è®¿é—®é™æµ"æ¨¡å—ã€‚

**1Panel ç½‘ç«™è®¾ç½®å®é™…åŒ…å«**:
| åŠŸèƒ½ | è¯´æ˜ | æ˜¯å¦ç”¨äºé˜²æ”»å‡» |
|-----|------|--------------|
| **æµé‡é™åˆ¶** | æ§åˆ¶å¸¦å®½/ä¸‹è½½æµé‡ | âŒ ä¸æ˜¯è¯·æ±‚é¢‘ç‡é™åˆ¶ |
| **é˜²ç›—é“¾** | é˜²æ­¢èµ„æºè¢«å…¶ä»–ç½‘ç«™å¼•ç”¨ | âœ… å¯ç”¨ |
| **å¯†ç è®¿é—®** | ç½‘ç«™è®¿é—®éœ€å¯†ç  | âš ï¸ ä»…åŸºç¡€ä¿æŠ¤ |
| **HTTPS** | SSL è¯ä¹¦é…ç½® | âœ… å¿…é¡» |
| **é…ç½®æ–‡ä»¶** | ç¼–è¾‘ nginx é…ç½® | âœ… **æ ¸å¿ƒå…¥å£** |

### 1.2 æ­£ç¡®çš„é˜²æŠ¤é…ç½®æµç¨‹

```mermaid
graph LR
    A[æ‰“å¼€1Panel] --> B[å•†åº—å®‰è£…Fail2ban]
    B --> C[ç½‘ç«™â†’é…ç½®æ–‡ä»¶â†’ç¼–è¾‘nginx]
    C --> D[æ·»åŠ é™æµé…ç½®]
    D --> E[ä¿å­˜å¹¶é‡è½½]
```

**å…³é”®è·¯å¾„**:
```
1Panel â†’ ç½‘ç«™ â†’ é€‰æ‹©ç½‘ç«™ â†’ é…ç½®æ–‡ä»¶ â†’ ç¼–è¾‘ nginx é…ç½®
```

---

## äºŒã€Fail2ban æ ¸å¿ƒé…ç½®

### 2.1 é€šè¿‡ 1Panel å®‰è£… Fail2ban

```
1Panel é¢æ¿ â†’ åº”ç”¨å•†åº— â†’ æœç´¢ "Fail2ban" â†’ å®‰è£…
```

**å®‰è£…åçš„æ—¥å¿—è·¯å¾„**:
```bash
# 1Panel ç®¡ç†çš„ OpenResty æ—¥å¿—
/opt/1panel/apps/openresty/openresty/logs/

# æˆ–æ ‡å‡† OpenResty æ—¥å¿—
/usr/local/openresty/nginx/logs/
```

### 2.2 é€šè¿‡ 1Panel ç¼–è¾‘ Fail2ban é…ç½®

```
åº”ç”¨ â†’ å·²å®‰è£… â†’ Fail2ban â†’ é…ç½®ç¼–è¾‘
```

æ‰¾åˆ° `jail.d/` ç›®å½•ï¼Œåˆ›å»ºæˆ–ç¼–è¾‘ `website-protection.conf`:

```ini
[DEFAULT]
# å°ç¦æ—¶é—´ï¼ˆç§’ï¼‰
bantime = 3600

# æ£€æµ‹æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
findtime = 600

# è§¦å‘é˜ˆå€¼
maxretry = 10

# å¿½ç•¥IPï¼ˆç™½åå•ï¼‰
ignoreip = 127.0.0.1/8 ::1

# ========== OpenResty é™æµæ£€æµ‹ ==========
[openresty-req-limit]
enabled = true
filter = nginx-req-limit
action = iptables-multiport[name=ReqLimit, port="http,https", protocol=tcp]
logpath = /opt/1panel/apps/openresty/openresty/logs/*error.log
         /usr/local/openresty/nginx/logs/*error.log
maxretry = 5
findtime = 60
bantime = 1800

# ========== OpenResty æ¶æ„æ‰«æ ==========
[openresty-badbots]
enabled = true
filter = nginx-badbots
action = iptables-multiport[name=BadBots, port="http,https", protocol=tcp]
logpath = /opt/1panel/apps/openresty/openresty/logs/*access.log
         /usr/local/openresty/nginx/logs/*access.log
maxretry = 2
findtime = 600
bantime = 86400

# ========== OpenResty 404 æ‰«æ ==========
[openresty-noscript]
enabled = true
filter = nginx-noscript
action = iptables-multiport[name=NoScript, port="http,https", protocol=tcp]
logpath = /opt/1panel/apps/openresty/openresty/logs/*access.log
         /usr/local/openresty/nginx/logs/*access.log
maxretry = 3
findtime = 300
bantime = 7200

# ========== SSH ä¿æŠ¤ ==========
[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
findtime = 300
bantime = 3600
```

### 2.3 åˆ›å»ºè‡ªå®šä¹‰è¿‡æ»¤å™¨

åœ¨ 1Panel ä¸­:
```
åº”ç”¨ â†’ Fail2ban â†’ é…ç½®ç¼–è¾‘ â†’ filter.d/nginx-req-limit.conf
```

```ini
[Definition]
failregex = limiting requests, excess:.* by zone.*client: <HOST>
            limiting requests, exceed.* by zone.*client: <HOST>
            [error] \d+#\d+: \*\d+ limiting requests.*client: <HOST>
ignoreregex =
```

### 2.4 é‡å¯å¹¶éªŒè¯

```
åº”ç”¨ â†’ Fail2ban â†’ é‡å¯
```

æˆ–åœ¨ç»ˆç«¯æ‰§è¡Œ:
```bash
# æŸ¥çœ‹çŠ¶æ€
fail2ban-client status

# æŸ¥çœ‹ç‰¹å®š jail çŠ¶æ€
fail2ban-client status openresty-req-limit

# è§£å° IP
fail2ban-client set openresty-req-limit unbanip 1.2.3.4
```

---

## ä¸‰ã€OpenResty é™æµé…ç½®ï¼ˆé€šè¿‡ 1Panel ç¼–è¾‘ï¼‰

### 3.1 ã€æ¨èã€‘ä¸€é”®åº”ç”¨åˆ°æ‰€æœ‰ç½‘ç«™

**æ–¹æ³•ï¼šç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶ï¼Œå…¨å±€å¯ç”¨é™æµ**

```
1Panel â†’ ç½‘ç«™ â†’ é…ç½®æ–‡ä»¶ â†’ ä¸»é…ç½®ï¼ˆnginx.confï¼‰
```

æ‰¾åˆ° `http` å—ï¼Œåœ¨**æœ€é¡¶éƒ¨**æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```nginx
http {
    # ========== å…¨å±€é™æµåŒºåŸŸå®šä¹‰ ==========
    # åŸºäº IP çš„é™æµï¼šæ¯ç§’ 10 ä¸ªè¯·æ±‚
    limit_req_zone $binary_remote_addr zone=global_limit:10m rate=10r/s;

    # ç™»å½•/æ¥å£ä¸¥æ ¼é™æµï¼šæ¯ç§’ 5 ä¸ªè¯·æ±‚
    limit_req_zone $binary_remote_addr zone=strict_limit:10m rate=5r/s;

    # å…¨å±€å¹¶å‘è¿æ¥é™åˆ¶
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    # ========== å…¨å±€é™æµè§„åˆ™æ–‡ä»¶ ==========
    # å°† include æŒ‡ä»¤æ”¾åœ¨ http å—çš„æœ«å°¾ï¼Œåœ¨æ‰€æœ‰ server å—ä¹‹å
    # è¿™æ ·å¯ä»¥è®©é™æµè‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰ç½‘ç«™
    include /opt/1panel/apps/openresty/openresty/conf.d/rate-limit.conf;
}
```

**ç„¶ååˆ›å»ºé™æµè§„åˆ™æ–‡ä»¶**ï¼š

```bash
# åˆ›å»ºé™æµè§„åˆ™æ–‡ä»¶
nano /opt/1panel/apps/openresty/openresty/conf.d/rate-limit.conf
```

```nginx
# ========== å…¨å±€é™æµè§„åˆ™ï¼ˆè‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰ç½‘ç«™ï¼‰ ==========
# è¿™ä¸ªæ–‡ä»¶ä¼šè¢«ä¸»é…ç½®æ–‡ä»¶ includeï¼Œå¯¹æ‰€æœ‰ server ç”Ÿæ•ˆ

# åˆ›å»ºä¸€ä¸ªé€šç”¨çš„ location è§„åˆ™
# æ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•ä½¿ç”¨ map å’Œ if æ¡ä»¶æ¥å®ç°å…¨å±€é™æµ
```

**âš ï¸ æ›´ç®€å•çš„æ–¹æ¡ˆ**ï¼šç›´æ¥åœ¨æ¯ä¸ªç½‘ç«™é…ç½®ä¸­æ·»åŠ é™æµ

ç”±äº nginx çš„ `limit_req` æŒ‡ä»¤å¿…é¡»åœ¨ location/server å—ä¸­ä½¿ç”¨ï¼Œ**æœ€ç®€å•çš„æ–¹æ³•**æ˜¯ï¼š

1. åœ¨ `http` å—ä¸­å®šä¹‰é™æµåŒºåŸŸï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
2. åœ¨æ¯ä¸ªç½‘ç«™çš„ server é…ç½®ä¸­æ·»åŠ ä¸€è¡Œé™æµæŒ‡ä»¤

**ç¤ºä¾‹æ¨¡æ¿**ï¼ˆå¯å¤åˆ¶åˆ°æ‰€æœ‰ç½‘ç«™ï¼‰ï¼š

```nginx
http {
    # é™æµåŒºåŸŸå®šä¹‰ï¼ˆä¸»é…ç½®ä¸­åªéœ€é…ç½®ä¸€æ¬¡ï¼‰
    limit_req_zone $binary_remote_addr zone=global_limit:10m rate=10r/s;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    # æ¯ä¸ªç½‘ç«™çš„ server å—ä¸­æ·»åŠ ï¼š
    server {
        listen 80;
        server_name example.com;

        # === å¤åˆ¶è¿™3è¡Œåˆ°æ‰€æœ‰ç½‘ç«™ ===
        limit_req zone=global_limit burst=20 nodelay;
        limit_conn conn_limit 10;
        limit_req_status 429;

        # å…¶ä»–åŸæœ‰é…ç½®...
        root /www/wwwroot/example.com;
        index index.html;
    }
}
```

### 3.2 é€šè¿‡ 1Panel ç¼–è¾‘å•ä¸ªç½‘ç«™é…ç½®

```
1Panel â†’ ç½‘ç«™ â†’ é€‰æ‹©ç½‘ç«™ â†’ é…ç½®æ–‡ä»¶
```

æ‰¾åˆ° `http` å—ï¼Œæ·»åŠ é™æµé…ç½®ï¼š

```nginx
http {
    # ========== é™æµåŒºåŸŸå®šä¹‰ ==========
    # åŸºäº IP çš„é™æµï¼šæ¯ç§’ 10 ä¸ªè¯·æ±‚
    limit_req_zone $binary_remote_addr zone=general_limit:10m rate=10r/s;

    # ç™»å½•æ¥å£ä¸¥æ ¼é™æµï¼šæ¯ç§’ 3 ä¸ªè¯·æ±‚
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=3r/s;

    # å¹¶å‘è¿æ¥é™åˆ¶
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    server {
        listen 80;
        server_name example.com;

        # å…¨å±€å¹¶å‘è¿æ¥é™åˆ¶ï¼šå•IPæœ€å¤š5ä¸ªè¿æ¥
        limit_conn conn_limit 5;

        # å…¨å±€è¯·æ±‚é€Ÿç‡é™åˆ¶
        limit_req zone=general_limit burst=20 nodelay;

        # è‡ªå®šä¹‰é™æµå“åº”
        limit_req_status 429;

        # ç½‘ç«™æ ¹ç›®å½•
        root /www/wwwroot/example.com;
        index index.html index.php;

        # ç™»å½•æ¥å£ç‰¹æ®Šé™åˆ¶
        location /admin/login {
            limit_req zone=login_limit burst=5 nodelay;
            # ... å…¶ä»–é…ç½®
        }

        # API æ¥å£é™åˆ¶
        location /api/ {
            limit_req zone=login_limit burst=10 nodelay;
            # ... å…¶ä»–é…ç½®
        }

        # è‡ªå®šä¹‰ 429 å“åº”é¡µé¢
        error_page 429 /429.html;
        location = /429.html {
            return 429 '{"error": "Too many requests, please slow down"}';
            add_header Content-Type application/json;
        }
    }
}
```

### 3.2 é™æµå‚æ•°è¯´æ˜

| å‚æ•°             | è¯´æ˜          | æ¨èå€¼                   |
| -------------- | ----------- | --------------------- |
| `rate`         | æ¯ç§’è¯·æ±‚æ•°       | æ™®é€šé¡µé¢ 10r/sï¼ŒAPI 3-5r/s |
| `burst`        | çªå‘ç¼“å†²åŒº       | rate çš„ 2-3 å€          |
| `nodelay`      | ä¸å»¶è¿Ÿå¤„ç† burst | ç”Ÿäº§ç¯å¢ƒå¿…é¡»å¼€å¯              |
| `zone=...:10m` | å…±äº«å†…å­˜å¤§å°      | 1M å¯å­˜çº¦ 1.6ä¸‡ ä¸ªIP       |

### 3.3 IP é»‘åå•é…ç½®

åœ¨ `http` å—ä¸­æ·»åŠ ï¼š

```nginx
http {
    # ========== IP é»‘åå• ==========
    geo $blocked_ips {
        default 0;
        1.2.3.4 1;        # å•ä¸ª IP
        5.6.0.0/16 1;     # IP æ®µ
    }

    server {
        # é»‘åå•ç›´æ¥è¿”å› 403
        if ($blocked_ips) {
            return 403 "Your IP has been blocked";
        }

        # å…¶ä»–é…ç½®...
    }
}
```

### 3.4 User-Agent è¿‡æ»¤

```nginx
http {
    # å±è”½æ¶æ„çˆ¬è™«å’Œç©º UA
    map $http_user_agent $blocked_ua {
        default 0;
        ~*(?:curl|wget|python|scanner|hack) 1;
        ~*(?:spider|crawler|bot|scan) 1;
        "" 1;                                  # ç©º UA
        ~*^-?$ 1;                              # åªæœ‰æ¨ªçº¿
    }

    server {
        if ($blocked_ua) {
            return 403 "Forbidden User-Agent";
        }

        # å…¶ä»–é…ç½®...
    }
}
```

---

## å››ã€OpenResty Lua é«˜çº§é™æµï¼ˆæ›´å¼ºå¤§ï¼‰

### 4.0 ã€ç»ˆææ–¹æ¡ˆã€‘ä¸€æ¬¡é…ç½®ï¼Œæ‰€æœ‰ç½‘ç«™è‡ªåŠ¨ç”Ÿæ•ˆ

**åŸç†**ï¼šä½¿ç”¨ OpenResty çš„ Lua è„šæœ¬èƒ½åŠ›ï¼Œåœ¨ `http` å—ä¸­å…¨å±€å¯ç”¨é™æµï¼Œæ— éœ€ä¿®æ”¹æ¯ä¸ªç½‘ç«™é…ç½®ï¼

#### é…ç½®æ­¥éª¤

**Step 1: åˆ›å»ºå…¨å±€ Lua é™æµè„šæœ¬**

```bash
# åˆ›å»ºé™æµè„šæœ¬ç›®å½•
mkdir -p /opt/1panel/apps/openresty/openresty/lua

# åˆ›å»ºé™æµè„šæœ¬
nano /opt/1panel/apps/openresty/openresty/lua/global_rate_limit.lua
```

```lua
-- global_rate_limit.lua
-- å…¨å±€é™æµè„šæœ¬ï¼ˆè‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰ç½‘ç«™ï¼‰

local _M = {}

-- å…±äº«å†…å­˜å­—å…¸ï¼ˆåœ¨ nginx.conf ä¸­å®šä¹‰ï¼‰
local limit_dict = ngx.shared.rate_limit

-- é™æµé…ç½®
local CONFIG = {
    -- æ™®é€šè¯·æ±‚ï¼šæ¯ç§’ 10 æ¬¡ï¼Œburst 20
    normal = {rate = 10, burst = 20},

    -- ä¸¥æ ¼è·¯å¾„ï¼šæ¯ç§’ 3 æ¬¡ï¼ˆç™»å½•ã€API ç­‰ï¼‰
    strict = {rate = 3, burst = 5},

    -- å¹¶å‘è¿æ¥ï¼šæ¯ä¸ª IP æœ€å¤š 10 ä¸ªè¿æ¥
    conn_limit = 10,

    -- ç™½åå• IPï¼ˆä¸é™æµï¼‰
    whitelist = {
        ["127.0.0.1"] = true,
        ["::1"] = true,
    },

    -- ä¸¥æ ¼é™æµçš„è·¯å¾„å‰ç¼€
    strict_paths = {
        ["/api/"] = true,
        ["/admin/"] = true,
        ["/login"] = true,
        ["/wp-login.php"] = true,
    }
}

-- æ£€æŸ¥æ˜¯å¦ä¸ºä¸¥æ ¼é™æµè·¯å¾„
local function is_strict_path(uri)
    for prefix, _ in pairs(CONFIG.strict_paths) do
        if uri:sub(1, #prefix) == prefix then
            return true
        end
    end
    return false
end

-- ä»¤ç‰Œæ¡¶ç®—æ³•é™æµ
local function rate_limit(key, rate, burst)
    local now = ngx.now()
    local key_info = limit_dict:get(key)

    -- åˆå§‹åŒ–ä»¤ç‰Œæ¡¶
    if not key_info then
        local info = {tokens = burst, last_time = now}
        limit_dict:set(key, cjson.encode(info), 3600)
        return true
    end

    local info = cjson.decode(key_info)
    local elapsed = now - info.last_time

    -- è¡¥å……ä»¤ç‰Œ
    info.tokens = math.min(burst, info.tokens + elapsed * rate)
    info.last_time = now

    -- æ¶ˆè€—ä»¤ç‰Œ
    if info.tokens >= 1 then
        info.tokens = info.tokens - 1
        limit_dict:set(key, cjson.encode(info), 3600)
        return true
    else
        limit_dict:set(key, cjson.encode(info), 3600)
        return false
    end
end

-- å¹¶å‘è¿æ¥é™æµ
local function conn_limit(ip)
    local conn_key = "conn:" .. ip
    local current, err = limit_dict:incr(conn_key, 1, 0)

    if not current then
        limit_dict:set(conn_key, 1, 60)
        return true
    end

    if current > CONFIG.conn_limit then
        return false
    end

    -- è¯·æ±‚ç»“æŸæ—¶é€’å‡ï¼ˆåœ¨ log é˜¶æ®µï¼‰
    return true
end

-- ä¸»é™æµå‡½æ•°
function _M.limit()
    local ip = ngx.var.remote_addr
    local uri = ngx.var.uri

    -- ç™½åå•æ£€æŸ¥
    if CONFIG.whitelist[ip] then
        return
    end

    -- å¹¶å‘è¿æ¥é™åˆ¶
    if not conn_limit(ip) then
        ngx.status = 429
        ngx.header["Content-Type"] = "application/json; charset=utf-8"
        ngx.say('{"error": "Too many connections", "code": 429}')
        ngx.exit(429)
        return
    end

    -- è¯·æ±‚é€Ÿç‡é™åˆ¶
    local is_strict = is_strict_path(uri)
    local config = is_strict and CONFIG.strict or CONFIG.normal
    local key = "rate:" .. ip .. (is_strict and ":strict" or ":normal")

    if not rate_limit(key, config.rate, config.burst) then
        ngx.status = 429
        ngx.header["Content-Type"] = "application/json; charset=utf-8"
        ngx.say('{"error": "Too many requests, please slow down", "code": 429}')
        ngx.exit(429)
        return
    end
end

return _M
```

**Step 2: ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶**

```
1Panel â†’ ç½‘ç«™ â†’ é…ç½®æ–‡ä»¶ â†’ ä¸»é…ç½®ï¼ˆnginx.confï¼‰
```

åœ¨ `http {` å—çš„**å¼€å¤´**æ·»åŠ ï¼š

```nginx
http {
    # ========== Lua å…¨å±€é™æµé…ç½®ï¼ˆä¸€æ¬¡é…ç½®ï¼Œæ‰€æœ‰ç½‘ç«™ç”Ÿæ•ˆï¼‰==========

    # å…±äº«å†…å­˜ï¼šå­˜å‚¨é™æµçŠ¶æ€
    lua_shared_dict rate_limit 20m;

    # æŒ‡å®š Lua è„šæœ¬è·¯å¾„
    lua_package_path "/opt/1panel/apps/openresty/openresty/lua/?.lua;;";

    # å…¨å±€é™æµï¼šåœ¨æ‰€æœ‰è¯·æ±‚å¤„ç†å‰æ‰§è¡Œ
    init_by_lua_block {
        -- é¢„åŠ è½½é™æµæ¨¡å—
        require("global_rate_limit")
    }

    # åœ¨æ¯ä¸ªè¯·æ±‚çš„ access é˜¶æ®µæ‰§è¡Œé™æµæ£€æŸ¥
    # è¿™ä¼šåº”ç”¨åˆ°æ‰€æœ‰ serverã€æ‰€æœ‰ locationï¼
    access_by_lua_block {
        local rate_limit = require("global_rate_limit")
        rate_limit.limit()
    }

    # è¯·æ±‚ç»“æŸæ—¶æ¸…ç†è¿æ¥è®¡æ•°
    log_by_lua_block {
        local ip = ngx.var.remote_addr
        local dict = ngx.shared.rate_limit
        local conn_key = "conn:" .. ip
        dict:incr(conn_key, -1)
    }

    # ========== ä»¥ä¸Šé…ç½®å®Œæˆåï¼Œæ‰€æœ‰ç½‘ç«™è‡ªåŠ¨ç”Ÿæ•ˆé™æµ ==========
    # ========== æ— éœ€ä¿®æ”¹ä»»ä½•å•ä¸ªç½‘ç«™çš„é…ç½® ==========

    # å…¶ä»–åŸæœ‰é…ç½®...
}
```

**Step 3: é‡è½½é…ç½®**

```bash
# æµ‹è¯•é…ç½®
openresty -t

# é‡è½½
openresty -s reload
```

**Step 4: éªŒè¯ç”Ÿæ•ˆ**

```bash
# æµ‹è¯•é™æµï¼ˆå¿«é€Ÿå‘é€ 20 ä¸ªè¯·æ±‚ï¼‰
for i in {1..20}; do curl -I http://ä½ çš„åŸŸå; done

# æŸ¥çœ‹å…±äº«å†…å­˜çŠ¶æ€
curl http://localhost/nginx_status 2>/dev/null || echo "éœ€å¯ç”¨ stub_status æ¨¡å—"
```

#### é…ç½®è¯´æ˜

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| æ™®é€šè¯·æ±‚é™æµ | æ¯ç§’è¯·æ±‚æ•° | 10 req/s |
| ä¸¥æ ¼è·¯å¾„é™æµ | API/ç™»å½•ç­‰æ¯ç§’è¯·æ±‚æ•° | 3 req/s |
| å¹¶å‘è¿æ¥ | å• IP æœ€å¤§è¿æ¥æ•° | 10 |
| å…±äº«å†…å­˜ | é™æµçŠ¶æ€å­˜å‚¨ | 20M |

#### è‡ªå®šä¹‰é…ç½®

ç¼–è¾‘ `/opt/1panel/apps/openresty/openresty/lua/global_rate_limit.lua` ä¸­çš„ `CONFIG` éƒ¨åˆ†ï¼š

```lua
local CONFIG = {
    -- è°ƒæ•´æ™®é€šè¯·æ±‚é™æµ
    normal = {rate = 20, burst = 40},  -- æ”¹ä¸ºæ¯ç§’ 20 æ¬¡

    -- è°ƒæ•´ä¸¥æ ¼é™æµ
    strict = {rate = 5, burst = 10},   -- æ”¹ä¸ºæ¯ç§’ 5 æ¬¡

    -- æ·»åŠ ç™½åå• IP
    whitelist = {
        ["127.0.0.1"] = true,
        ["ä½ çš„IP"] = true,  -- æ·»åŠ ä½ çš„ IP
    },

    -- æ·»åŠ ä¸¥æ ¼é™æµè·¯å¾„
    strict_paths = {
        ["/api/"] = true,
        ["/admin/"] = true,
        ["/ä½ çš„è·¯å¾„"] = true,  -- æ·»åŠ æ–°è·¯å¾„
    }
}
```

#### ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | ä¼ ç»Ÿ limit_req | Lua å…¨å±€é™æµ |
|------|---------------|--------------|
| ä¸€æ¬¡é…ç½®å…¨éƒ¨ç”Ÿæ•ˆ | âŒ éœ€è¦ | âœ… æ˜¯ |
| éœ€ä¿®æ”¹æ¯ä¸ªç½‘ç«™ | âœ… æ˜¯ | âŒ ä¸éœ€è¦ |
| åŠ¨æ€è°ƒæ•´ | âŒ éœ€é‡è½½ | âœ… æ˜¯ï¼ˆä¿®æ”¹è„šæœ¬å³å¯ï¼‰ |
| ç²¾ç¡®æ§åˆ¶è·¯å¾„ | âš ï¸ éœ€é€ä¸ªé…ç½® | âœ… é…ç½®ä¸€æ¬¡ |
| ç»Ÿè®¡ç›‘æ§ | âš ï¸ å›°éš¾ | âœ… å¯æ‰©å±• |

---

### 4.1 åˆ›å»º Lua é™æµè„šæœ¬ï¼ˆRedis ç‰ˆæœ¬ï¼‰

é€šè¿‡ 1Panel æˆ–ç»ˆç«¯åˆ›å»ºæ–‡ä»¶ï¼š

```bash
# è·¯å¾„ç¤ºä¾‹
mkdir -p /opt/1panel/apps/openresty/openresty/lua
nano /opt/1panel/apps/openresty/openresty/lua/rate_limit.lua
```

```lua
-- rate_limit.lua
local redis = require "resty.redis"
local red = redis:new()

red:set_timeout(1000)

local ok, err = red:connect("127.0.0.1", 6379)
if not ok then
    ngx.log(ngx.ERR, "Redis connection failed: ", err)
    return
end

local client_ip = ngx.var.remote_addr
local key = "rate_limit:" .. client_ip

-- é€’å¢è®¡æ•°
local requests, err = red:incr(key)

if requests == 1 then
    red:expire(key, 60)  -- 60 ç§’çª—å£
end

-- é™æµï¼š1 åˆ†é’Ÿæœ€å¤š 100 æ¬¡
if requests > 100 then
    ngx.status = 429
    ngx.say("Too many requests")
    ngx.exit(429)
end
```

### 4.2 åœ¨ nginx.conf ä¸­è°ƒç”¨

```nginx
http {
    lua_shared_dict limit_counter 10m;
    lua_package_path "/opt/1panel/apps/openresty/openresty/lua/?.lua;;";

    server {
        location / {
            access_by_lua_block {
                require("rate_limit")
            }
        }
    }
}
```

---

## äº”ã€ä¸€é”®éƒ¨ç½² WAFï¼ˆæ¨èæ–¹æ¡ˆï¼‰

### 5.1 å®‰è£…é›·æ±  SafeLine WAF

```
1Panel â†’ åº”ç”¨å•†åº— â†’ æœç´¢ "é›·æ± " æˆ– "SafeLine" â†’ å®‰è£…
```

**é›·æ±  WAF åŠŸèƒ½**:
- âœ… è‡ªåŠ¨é˜²æŠ¤ SQL æ³¨å…¥ã€XSSã€CC æ”»å‡»
- âœ… å›¾å½¢åŒ–ç®¡ç†ç•Œé¢
- âœ… å®æ—¶æ”»å‡»æ—¥å¿—åˆ†æ
- âœ… ä¸€é”®å°ç¦æ¶æ„ IP

### 5.2 é…ç½® WAF ä»£ç†

å®‰è£…åï¼Œå°†ç½‘ç«™æµé‡ç»è¿‡ WAFï¼š

```nginx
server {
    listen 80;
    server_name example.com;

    # åå‘ä»£ç†åˆ° WAFï¼ˆç«¯å£æ ¹æ®å®é™…å®‰è£…è°ƒæ•´ï¼‰
    location / {
        proxy_pass http://127.0.0.1:9443;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## å…­ã€ç›‘æ§ä¸è¯Šæ–­

### 6.1 1Panel å†…ç½®ç›‘æ§

```
ç½‘ç«™ â†’ é€‰æ‹©ç½‘ç«™ â†’ ç›‘æ§
```

### 6.2 å¿«é€Ÿè¯Šæ–­å‘½ä»¤

```bash
# æŸ¥çœ‹å½“å‰è¿æ¥æœ€å¤šçš„ IP
netstat -ntu | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -nr | head -20

# æŸ¥çœ‹ OpenResty çŠ¶æ€ï¼ˆéœ€å¯ç”¨ stub_statusï¼‰
curl http://localhost/nginx_status

# å®æ—¶æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /opt/1panel/apps/openresty/openresty/logs/error.log

# æŸ¥çœ‹ Fail2ban å°ç¦çŠ¶æ€
fail2ban-client status openresty-req-limit
```

---

## ä¸ƒã€åº”æ€¥å“åº”æµç¨‹

### æ”»å‡»å¤„ç†æµç¨‹

```mermaid
graph TD
    A[å‘ç°å¼‚å¸¸] --> B{æ”»å‡»ç±»å‹?}
    B -->|DDoS| C[å¯ç”¨ CDN]
    B -->|æš´åŠ›ç ´è§£| D[åŠ å¼º Fail2ban]
    B -->|CCæ”»å‡»| E[é™ä½é™æµé˜ˆå€¼]
    C --> F[æ‰¹é‡å°ç¦ IP]
    D --> F
    E --> F
    F --> G[è§‚å¯Ÿç›‘æ§]
    G --> H[æ¢å¤æ­£å¸¸]
```

### å¿«é€Ÿåº”æ€¥æ“ä½œ

| ç´§æ€¥æƒ…å†µ | æ“ä½œ |
|---------|------|
| ç½‘ç«™è¢«åˆ· | ç¼–è¾‘ nginx é…ç½®ï¼Œé™ä½ `rate` å€¼ä¸º `1r/s` |
| æ¶æ„ IP | åœ¨ `geo $blocked_ips` ä¸­æ·»åŠ  |
| æš´åŠ›ç ´è§£ | Fail2ban é™ä½ `maxretry` ä¸º `2` |
| æµé‡æš´å¢ | å¯ç”¨ Cloudflare CDN |

### å¿«é€Ÿå‘½ä»¤

```bash
# ç«‹å³å°ç¦å•ä¸ª IP
iptables -A INPUT -s 1.2.3.4 -j DROP

# å°ç¦ IP æ®µ
iptables -A INPUT -s 1.2.3.0/24 -j DROP

# æŸ¥çœ‹å°ç¦åˆ—è¡¨
iptables -L INPUT -n -v | grep DROP

# è§£é™¤å°ç¦
iptables -D INPUT -s 1.2.3.4 -j DROP

# é‡è½½ OpenRestyï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰
openresty -s reload

# Fail2ban æ‰‹åŠ¨å°ç¦
fail2ban-client set openresty-req-limit banip 1.2.3.4

# Fail2ban è§£å°
fail2ban-client set openresty-req-limit unbanip 1.2.3.4
```

---

## å…«ã€æ¨èé…ç½®æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šå°æµé‡ç½‘ç«™ï¼ˆæ¨èï¼‰

| åŠŸèƒ½ | é…ç½®æ–¹å¼ |
|-----|---------|
| è¯·æ±‚é™æµ | nginx é…ç½® `limit_req` |
| IP é»‘åå• | nginx `geo` æ¨¡å— |
| Fail2ban | 1Panel å•†åº—å®‰è£… |
| HTTPS | 1Panel å†…ç½® Let's Encrypt |
| CDN | Cloudflare å…è´¹ç‰ˆ |

### æ–¹æ¡ˆ Bï¼šä¸­æµé‡ç½‘ç«™

| åŠŸèƒ½ | é…ç½®æ–¹å¼ |
|-----|---------|
| æ™ºèƒ½é™æµ | OpenResty + Redis Lua è„šæœ¬ |
| WAF | é›·æ±  SafeLine |
| ç›‘æ§ | 1Panel å†…ç½®ç›‘æ§ |
| CDN | é˜¿é‡Œäº‘/è…¾è®¯äº‘ CDN |

### æ–¹æ¡ˆ Cï¼šé«˜é˜²ç½‘ç«™

| åŠŸèƒ½ | é…ç½®æ–¹å¼ |
|-----|---------|
| DDoS é˜²æŠ¤ | é«˜é˜² IP / é«˜é˜² CDN |
| WAF | é›·æ± ä¼ä¸šç‰ˆ |
| ç›‘æ§ | Grafana + Prometheus |

---

## ä¹ã€é…ç½®æ£€æŸ¥æ¸…å•

### åŸºç¡€é˜²æŠ¤
- [ ] Fail2ban å·²å®‰è£…ï¼ˆ1Panel å•†åº—ï¼‰
- [ ] nginx é™æµå·²é…ç½®ï¼ˆé…ç½®æ–‡ä»¶ç¼–è¾‘ï¼‰
- [ ] SSL è¯ä¹¦å·²å¯ç”¨
- [ ] éšè—æœåŠ¡å™¨ç‰ˆæœ¬ä¿¡æ¯

### é«˜çº§é˜²æŠ¤
- [ ] Lua é™æµè„šæœ¬å·²éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰
- [ ] WAF å·²å®‰è£…ï¼ˆé›·æ±  SafeLineï¼‰
- [ ] ç›‘æ§å·²é…ç½®
- [ ] å¤‡ä»½è®¡åˆ’å·²è®¾ç½®

---

## åã€å¸¸è§é—®é¢˜

### Q1: 1Panel æ—¥å¿—è·¯å¾„åœ¨å“ªé‡Œï¼Ÿ

```bash
# 1Panel OpenResty é»˜è®¤è·¯å¾„
/opt/1panel/apps/openresty/openresty/logs/
```

### Q2: å¦‚ä½•æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼Ÿ

```bash
# æ–¹å¼ä¸€ï¼šç»ˆç«¯
tail -f /opt/1panel/apps/openresty/openresty/logs/access.log

# æ–¹å¼äºŒï¼š1Panel ç•Œé¢
ç½‘ç«™ â†’ é€‰æ‹©ç½‘ç«™ â†’ æ—¥å¿—
```

### Q3: é…ç½®ä¿®æ”¹åå¦‚ä½•ç”Ÿæ•ˆï¼Ÿ

```bash
# æ–¹å¼ä¸€ï¼š1Panel ç•Œé¢
ç½‘ç«™ â†’ é…ç½®æ–‡ä»¶ â†’ ä¿å­˜åè‡ªåŠ¨é‡è½½

# æ–¹å¼äºŒï¼šå‘½ä»¤è¡Œ
openresty -s reload
```

### Q4: å¦‚ä½•æ‰¹é‡å°ç¦ IPï¼Ÿ

åœ¨ nginx é…ç½®ä¸­ï¼š
```nginx
geo $blocked_ips {
    default 0;
    1.2.3.4 1;
    5.6.7.8 1;
    9.10.0.0/16 1;
}
```

### Q5: ä¸ç”¨è„šæœ¬ï¼Œä¸€æ¬¡ä¿®æ”¹å¯¹æ‰€æœ‰ç½‘ç«™ç”Ÿæ•ˆï¼Ÿ

**æ³¨æ„**ï¼šä¼ ç»Ÿçš„ nginx `limit_req` æŒ‡ä»¤**æ— æ³•**åƒ Lua é‚£æ ·å®ç°çœŸæ­£çš„"ä¸€æ¬¡é…ç½®æ°¸ä¹…ç”Ÿæ•ˆ"ï¼Œå› ä¸ºå®ƒå¿…é¡»åœ¨ server å—ä¸­ä½¿ç”¨ã€‚

**æœ€æ¥è¿‘çš„è§£å†³æ–¹æ¡ˆ**ï¼š

---

#### æ–¹æ³•ä¸€ï¼šä¿®æ”¹ 1Panel ç½‘ç«™é…ç½®æ¨¡æ¿ï¼ˆæ¨èï¼‰

**åŸç†**ï¼šä¿®æ”¹ 1Panel ç”Ÿæˆç½‘ç«™é…ç½®çš„æ¨¡æ¿ï¼Œè®©æ‰€æœ‰æ–°å»ºç½‘ç«™è‡ªåŠ¨åŒ…å«é™æµé…ç½®ã€‚

```bash
# 1. æ‰¾åˆ° 1Panel çš„ç½‘ç«™é…ç½®æ¨¡æ¿
# é€šå¸¸ä½äº 1Panel å®‰è£…ç›®å½•ä¸‹
cd /opt/1panel

# 2. æœç´¢æ¨¡æ¿æ–‡ä»¶ï¼ˆå¯èƒ½çš„ä½ç½®ï¼‰
find . -name "*.tmpl" -o -name "*.tpl" | grep -i nginx
find . -path "*/openresty/*" -name "*template*"

# 3. ç¼–è¾‘æ¨¡æ¿æ–‡ä»¶
# æ‰¾åˆ°ç±»ä¼¼è¿™æ ·çš„æ¨¡æ¿æ–‡ä»¶ï¼š
# conf.d/site.conf.tmpl  æˆ–  openresty/conf.d/site.tmpl
nano <æ‰¾åˆ°çš„æ¨¡æ¿æ–‡ä»¶è·¯å¾„>
```

åœ¨æ¨¡æ¿çš„ `server {` å—ä¸­æ·»åŠ é™æµé…ç½®ï¼š

```nginx
server {
    listen {{PORT}};
    server_name {{DOMAIN}};

    # === é™æµé…ç½®ï¼ˆæ·»åŠ åˆ°æ¨¡æ¿ä¸­ï¼‰===
    limit_req zone=global_limit burst=20 nodelay;
    limit_conn conn_limit 10;
    limit_req_status 429;

    # å…¶ä»–åŸæœ‰é…ç½®...
}
```

**æ•ˆæœ**ï¼šä¹‹ååˆ›å»ºçš„æ–°ç½‘ç«™ä¼šè‡ªåŠ¨åŒ…å«é™æµé…ç½®ã€‚

---

#### æ–¹æ³•äºŒï¼šæ‰¹é‡ä¿®æ”¹ç°æœ‰ç½‘ç«™ï¼ˆä¸€æ¬¡æ€§ï¼‰

```bash
# å¤‡ä»½é…ç½®
cp -r /opt/1panel/apps/openresty/openresty/conf.d /opt/1panel/apps/openresty/openresty/conf.d.bak.$(date +%Y%m%d)

# æ‰¹é‡æ·»åŠ é™æµåˆ°æ‰€æœ‰ç½‘ç«™
cd /opt/1panel/apps/openresty/openresty/conf.d/
for file in *.conf; do
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰é™æµé…ç½®
    if ! grep -q "limit_req" "$file"; then
        # åœ¨ç¬¬ä¸€ä¸ª server { åæ·»åŠ é™æµ
        sed -i '0,/server {/s//server {\n        # é™æµé…ç½®\n        limit_req zone=global_limit burst=20 nodelay;\n        limit_conn conn_limit 10;\n        limit_req_status 429;/' "$file"
        echo "âœ“ å·²æ·»åŠ é™æµ: $file"
    else
        echo "âŠ˜ å·²æœ‰é™æµ: $file"
    fi
done

# æµ‹è¯•é…ç½®
openresty -t

# å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œé‡è½½
openresty -s reload
```

---

#### æ–¹æ³•ä¸‰ï¼šä¸€é”®é…ç½®è„šæœ¬ï¼ˆæœ€ç®€å•ï¼‰

```bash
#!/bin/bash
# ä¸€é”®ä¸ºæ‰€æœ‰ç½‘ç«™æ·»åŠ é™æµ

# é…ç½®å‚æ•°
RATE_LIMIT_ZONE="global_limit"
BURST=20
CONN_LIMIT=10

# ä¸»é…ç½®ä¸­å®šä¹‰é™æµåŒºåŸŸ
MAIN_CONF="/opt/1panel/apps/openresty/openresty/conf/nginx.conf"

# æ£€æŸ¥ä¸»é…ç½®ä¸­æ˜¯å¦å·²å®šä¹‰é™æµåŒºåŸŸ
if ! grep -q "limit_req_zone.*global_limit" "$MAIN_CONF"; then
    echo "æ­£åœ¨ä¸»é…ç½®ä¸­æ·»åŠ é™æµåŒºåŸŸå®šä¹‰..."
    # åœ¨ http å—ä¸­æ·»åŠ ï¼ˆéœ€è¦æ‰‹åŠ¨ç¼–è¾‘ï¼Œæˆ–ä½¿ç”¨ sedï¼‰
    echo "è¯·åœ¨ä¸»é…ç½®çš„ http { å—ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š"
    echo "limit_req_zone \$binary_remote_addr zone=global_limit:10m rate=10r/s;"
    echo "limit_conn_zone \$binary_remote_addr zone=conn_limit:10m;"
    read -p "æŒ‰å›è½¦ç»§ç»­..."
fi

# æ‰¹é‡æ·»åŠ åˆ°æ‰€æœ‰ç½‘ç«™
CONF_DIR="/opt/1panel/apps/openresty/openresty/conf.d"
COUNT=0

for conf in "$CONF_DIR"/*.conf; do
    if ! grep -q "limit_req" "$conf"; then
        sed -i '0,/server {/s//server {\n        limit_req zone=global_limit burst=20 nodelay;\n        limit_conn conn_limit 10;\n        limit_req_status 429;/' "$conf"
        ((COUNT++))
    fi
done

echo "å·²ä¸º $COUNT ä¸ªç½‘ç«™æ·»åŠ é™æµé…ç½®"
openresty -t && openresty -s reload
```

ä¿å­˜ä¸º `/usr/local/bin/add-rate-limit.sh`ï¼Œä½¿ç”¨ï¼š

```bash
chmod +x /usr/local/bin/add-rate-limit.sh
add-rate-limit.sh
```

---

#### æ€»ç»“

| æ–¹æ³• | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **ä¿®æ”¹æ¨¡æ¿** | æ–°ç½‘ç«™è‡ªåŠ¨ç”Ÿæ•ˆ | éœ€æ‰¾åˆ°æ¨¡æ¿æ–‡ä»¶ | ç»å¸¸åˆ›å»ºæ–°ç½‘ç«™ |
| **æ‰¹é‡ä¿®æ”¹** | ä¸€æ¬¡æ€§å¤„ç†ç°æœ‰ç½‘ç«™ | éœ€è¦æ‰§è¡Œè„šæœ¬ | æœ‰å¤šä¸ªç°æœ‰ç½‘ç«™ |
| **ä¸€é”®è„šæœ¬** | æœ€ç®€å•ï¼Œè‡ªåŠ¨å¤„ç† | éœ€è¦è¿è¡Œè„šæœ¬ | å¿«é€Ÿéƒ¨ç½² |

**é‡è¦æé†’**ï¼š
- ä¼ ç»Ÿ nginx `limit_req` æ— æ³•åšåˆ°çœŸæ­£çš„"ä¸€æ¬¡é…ç½®æ°¸ä¹…ç”Ÿæ•ˆ"
- å¦‚éœ€çœŸæ­£çš„å…¨å±€é™æµï¼Œè¯·ä½¿ç”¨ **Lua æ–¹æ¡ˆ**ï¼ˆè§ç¬¬å››èŠ‚ 4.0ï¼‰

---

## é™„å½•Aï¼šé™æµé…ç½®å¿«é€Ÿåº”ç”¨æŒ‡å—

### âš¡ 5åˆ†é’Ÿå®Œæˆå…¨ç«™é™æµé…ç½®

---

#### ğŸŒŸ æ–¹æ¡ˆé€‰æ‹©

| æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | æ˜¯å¦éœ€è¦æ”¹æ¯ä¸ªç½‘ç«™ |
|------|----------|-------------------|
| **æ–¹æ¡ˆä¸€ï¼šLua å…¨å±€é™æµ** | **æ¨èï¼** ä¸€æ¬¡é…ç½®ï¼Œæ‰€æœ‰ç½‘ç«™æ°¸ä¹…ç”Ÿæ•ˆ | âŒ ä¸éœ€è¦ |
| **æ–¹æ¡ˆäºŒï¼šä¼ ç»Ÿ limit_req** | ä¸æƒ³ç”¨ Luaï¼Œæ‰‹åŠ¨æ§åˆ¶æ¯ä¸ªç½‘ç«™ | âš ï¸ éœ€è¦æ¯ä¸ªç½‘ç«™æ·»åŠ  3 è¡Œ |

---

#### æ–¹æ¡ˆä¸€ï¼šLua å…¨å±€é™æµï¼ˆæ¨èï¼Œä¸€æ¬¡æå®šï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… åªéœ€åœ¨ä¸»é…ç½®æ·»åŠ ä¸€æ¬¡
- âœ… æ‰€æœ‰ç°æœ‰å’Œæ–°å»ºç½‘ç«™è‡ªåŠ¨ç”Ÿæ•ˆ
- âœ… è‡ªåŠ¨è¯†åˆ« API/ç™»å½•è·¯å¾„å¹¶ä¸¥æ ¼é™æµ
- âœ… æ— éœ€ä¿®æ”¹ä»»ä½•å•ä¸ªç½‘ç«™é…ç½®

**é…ç½®è·¯å¾„**ï¼š
```
1Panel â†’ ç½‘ç«™ â†’ é…ç½®æ–‡ä»¶ â†’ ä¸»é…ç½®ï¼ˆnginx.confï¼‰
```

åœ¨ `http {` å—å¼€å¤´æ·»åŠ ï¼š

```nginx
http {
    # å…±äº«å†…å­˜ï¼šå­˜å‚¨é™æµçŠ¶æ€
    lua_shared_dict rate_limit 20m;

    # æŒ‡å®š Lua è„šæœ¬è·¯å¾„
    lua_package_path "/opt/1panel/apps/openresty/openresty/lua/?.lua;;";

    # å…¨å±€é™æµï¼šåœ¨æ‰€æœ‰è¯·æ±‚å¤„ç†å‰æ‰§è¡Œ
    init_by_lua_block {
        require("global_rate_limit")
    }

    # åœ¨æ¯ä¸ªè¯·æ±‚çš„ access é˜¶æ®µæ‰§è¡Œé™æµæ£€æŸ¥
    access_by_lua_block {
        local rate_limit = require("global_rate_limit")
        rate_limit.limit()
    }

    # è¯·æ±‚ç»“æŸæ—¶æ¸…ç†è¿æ¥è®¡æ•°
    log_by_lua_block {
        local ip = ngx.var.remote_addr
        local dict = ngx.shared.rate_limit
        local conn_key = "conn:" .. ip
        dict:incr(conn_key, -1)
    }

    # å…¶ä»–åŸæœ‰é…ç½®...
}
```

ç„¶ååˆ›å»º Lua è„šæœ¬ï¼ˆè¯¦è§**ç¬¬å››èŠ‚ 4.0**å®Œæ•´ä»£ç ï¼‰ï¼š

```bash
mkdir -p /opt/1panel/apps/openresty/openresty/lua
nano /opt/1panel/apps/openresty/openresty/lua/global_rate_limit.lua
```

**å®Œæˆï¼** ç°åœ¨æ‰€æœ‰ç½‘ç«™éƒ½æœ‰é™æµä¿æŠ¤äº†ã€‚

---

#### æ–¹æ¡ˆäºŒï¼šä¼ ç»Ÿ limit_reqï¼ˆæ‰‹åŠ¨æ§åˆ¶æ¯ä¸ªç½‘ç«™ï¼‰

**Step 1: å®šä¹‰é™æµåŒºåŸŸï¼ˆåªéœ€åšä¸€æ¬¡ï¼‰**

```
1Panel â†’ ç½‘ç«™ â†’ é…ç½®æ–‡ä»¶ â†’ ä¸»é…ç½®ï¼ˆnginx.confï¼‰
```

åœ¨ `http {` å—å¼€å¤´æ·»åŠ ï¼š

```nginx
limit_req_zone $binary_remote_addr zone=global_limit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
```

**Step 2: ä¸ºæ¯ä¸ªç½‘ç«™å¯ç”¨é™æµ**

æœ‰ä¸¤ç§æ–¹å¼ï¼š

**æ–¹å¼Aï¼ˆæ¨èï¼‰** - æ¯ä¸ªç½‘ç«™æ‰‹åŠ¨æ·»åŠ  3 è¡Œä»£ç ï¼š

```
1Panel â†’ ç½‘ç«™ â†’ é€‰æ‹©ç½‘ç«™ â†’ é…ç½®æ–‡ä»¶
```

åœ¨ `server {` å—ä¸­æ·»åŠ ï¼š

```nginx
server {
    listen 80;
    # æ·»åŠ ä»¥ä¸‹ 3 è¡Œ
    limit_req zone=global_limit burst=20 nodelay;
    limit_conn conn_limit 10;
    limit_req_status 429;

    # ... å…¶ä»–é…ç½®ä¿æŒä¸å˜
}
```

**æ–¹å¼Bï¼ˆé«˜çº§ï¼‰** - ä½¿ç”¨è„šæœ¬æ‰¹é‡æ·»åŠ ï¼š

```bash
# ç¼–è¾‘ä¸»é…ç½®ï¼Œæ·»åŠ é™æµåŒºåŸŸï¼ˆå…ˆå®Œæˆ Step 1ï¼‰

# æ‰¹é‡æ·»åŠ é™æµåˆ°æ‰€æœ‰ç½‘ç«™
cd /opt/1panel/apps/openresty/openresty/conf.d/
for file in *.conf; do
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰é™æµé…ç½®
    if ! grep -q "limit_req" "$file"; then
        # åœ¨ç¬¬ä¸€ä¸ª server { åæ·»åŠ é™æµ
        sed -i '0,/server {/s//server {\n        limit_req zone=global_limit burst=20 nodelay;\n        limit_conn conn_limit 10;\n        limit_req_status 429;/' "$file"
        echo "å·²æ·»åŠ é™æµ: $file"
    fi
done

# æµ‹è¯•å¹¶é‡è½½
openresty -t && openresty -s reload
```

**Step 3: éªŒè¯é™æµæ˜¯å¦ç”Ÿæ•ˆ**

```bash
# æŸ¥çœ‹é™æµæ—¥å¿—
tail -f /opt/1panel/apps/openresty/openresty/logs/error.log | grep limiting

# æµ‹è¯•é™æµï¼ˆä¼šè¿”å› 429ï¼‰
for i in {1..20}; do curl -I http://ä½ çš„åŸŸå; done
```

### ğŸ“‹ å¿«é€Ÿå¤åˆ¶æ¨¡æ¿

**æ–¹æ¡ˆä¸€ï¼šLua å…¨å±€é™æµï¼ˆæ¨èï¼‰**

ä¸»é…ç½® `http {` å—æ·»åŠ ï¼ˆä¸€æ¬¡é…ç½®ï¼Œæ°¸ä¹…ç”Ÿæ•ˆï¼‰ï¼š

```nginx
# === Lua å…¨å±€é™æµï¼ˆæ¨èï¼‰===
lua_shared_dict rate_limit 20m;
lua_package_path "/opt/1panel/apps/openresty/openresty/lua/?.lua;;";
init_by_lua_block { require("global_rate_limit") }
access_by_lua_block { local r = require("global_rate_limit"); r.limit() }
log_by_lua_block { local d = ngx.shared.rate_limit; d:incr("conn:"..ngx.var.remote_addr, -1) }
```

**æ–¹æ¡ˆäºŒï¼šä¼ ç»Ÿ limit_reqï¼ˆæ‰‹åŠ¨ï¼‰**

æ¯ä¸ªç½‘ç«™ `server {` å—æ·»åŠ ï¼š

```nginx
# === ä¼ ç»Ÿé™æµé…ç½®ï¼ˆç²˜è´´åˆ° server { åï¼‰===
limit_req zone=global_limit burst=20 nodelay;
limit_conn conn_limit 10;
limit_req_status 429;
```

---

## å‚è€ƒèµ„æ–™

- [1Panel å®˜æ–¹æ–‡æ¡£ - ç½‘ç«™é…ç½®](https://1panel.cn/docs/v1/user_manual/websites/website_config_basic/)
- [OpenResty å®˜æ–¹æ–‡æ¡£](https://openresty.org/cn/)
- [é›·æ±  SafeLine WAF](https://waf-ce.chaitin.cn/)
- [Fail2ban å®˜æ–¹æ–‡æ¡£](https://fail2ban.readthedocs.io/)

---

> **æœ€åæ›´æ–°**: 2026-02-09
> **é€‚ç”¨ç‰ˆæœ¬**: 1Panel v1.10+ / OpenResty 1.25+
>
> **æ›´æ­£è¯´æ˜**: 1Panel çš„"æµé‡é™åˆ¶"æ˜¯å¸¦å®½æ§åˆ¶ï¼Œä¸æ˜¯è¯·æ±‚é¢‘ç‡é™åˆ¶ã€‚è¯·æ±‚é¢‘ç‡éœ€é€šè¿‡ç¼–è¾‘ nginx é…ç½®å®ç°ã€‚
