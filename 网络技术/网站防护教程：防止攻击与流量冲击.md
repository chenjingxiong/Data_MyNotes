# ç½‘ç«™é˜²æŠ¤æ•™ç¨‹ï¼šé˜²æ­¢æ”»å‡»ä¸æµé‡å†²å‡»

> **ç¯å¢ƒ**: OpenResty + 1Panel + Fail2ban
> **ç‰¹ç‚¹**: 1Panel ç®€åŒ–ç®¡ç† + OpenResty å¼ºå¤§æ‰©å±•èƒ½åŠ›

---

## ğŸ¯ ä¸€ã€å¿«é€Ÿå¼€å§‹ï¼ˆæ­£ç¡®çš„é…ç½®è·¯å¾„ï¼‰

### 1.1 1Panel å®é™…åŠŸèƒ½è¯´æ˜

**æ³¨æ„**: 1Panel æ²¡æœ‰"å®‰å…¨"æ ‡ç­¾å’Œ"è®¿é—®é™æµ"æ¨¡å—ã€‚

**1Panel ç½‘ç«™è®¾ç½®å®é™…åŒ…å«**:
| åŠŸèƒ½ | è¯´æ˜ | æ˜¯å¦ç”¨äºé˜²æ”»å‡» |
|-----|------|--------------|
| **æµé‡é™åˆ¶** | æ§åˆ¶å¸¦å®½/ä¸‹è½½æµé‡ | âŒ ä¸æ˜¯è¯·æ±‚é¢‘ç‡é™åˆ¶ |
| **é˜²ç›—é“¾** | é˜²æ­¢èµ„æºè¢«å…¶ä»–ç½‘ç«™å¼•ç”¨ | âœ… å¯ç”¨ |
| **å¯†ç è®¿é—®** | ç½‘ç«™è®¿é—®éœ€å¯†ç  | âš ï¸ ä»…åŸºç¡€ä¿æŠ¤ |
| **HTTPS** | SSL è¯ä¹¦é…ç½® | âœ… å¿…é¡» |
| **é…ç½®æ–‡ä»¶** | ç¼–è¾‘ nginx é…ç½® | âœ… **æ ¸å¿ƒå…¥å£** |

### 1.2 æ­£ç¡®çš„é˜²æŠ¤é…ç½®æµç¨‹

```mermaid
graph LR
    A[æ‰“å¼€1Panel] --> B[å•†åº—å®‰è£…Fail2ban]
    B --> C[ç½‘ç«™â†’é…ç½®æ–‡ä»¶â†’ç¼–è¾‘nginx]
    C --> D[æ·»åŠ é™æµé…ç½®]
    D --> E[ä¿å­˜å¹¶é‡è½½]
```

**å…³é”®è·¯å¾„**:
```
1Panel â†’ ç½‘ç«™ â†’ é€‰æ‹©ç½‘ç«™ â†’ é…ç½®æ–‡ä»¶ â†’ ç¼–è¾‘ nginx é…ç½®
```

---

## äºŒã€Fail2ban æ ¸å¿ƒé…ç½®

### 2.1 é€šè¿‡ 1Panel å®‰è£… Fail2ban

```
1Panel é¢æ¿ â†’ åº”ç”¨å•†åº— â†’ æœç´¢ "Fail2ban" â†’ å®‰è£…
```

**å®‰è£…åçš„æ—¥å¿—è·¯å¾„**:
```bash
# 1Panel ç®¡ç†çš„ OpenResty æ—¥å¿—
/opt/1panel/apps/openresty/openresty/logs/

# æˆ–æ ‡å‡† OpenResty æ—¥å¿—
/usr/local/openresty/nginx/logs/
```

### 2.2 é€šè¿‡ 1Panel ç¼–è¾‘ Fail2ban é…ç½®

```
åº”ç”¨ â†’ å·²å®‰è£… â†’ Fail2ban â†’ é…ç½®ç¼–è¾‘
```

æ‰¾åˆ° `jail.d/` ç›®å½•ï¼Œåˆ›å»ºæˆ–ç¼–è¾‘ `website-protection.conf`:

```ini
[DEFAULT]
# å°ç¦æ—¶é—´ï¼ˆç§’ï¼‰
bantime = 3600

# æ£€æµ‹æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
findtime = 600

# è§¦å‘é˜ˆå€¼
maxretry = 10

# å¿½ç•¥IPï¼ˆç™½åå•ï¼‰
ignoreip = 127.0.0.1/8 ::1

# ========== OpenResty é™æµæ£€æµ‹ ==========
[openresty-req-limit]
enabled = true
filter = nginx-req-limit
action = iptables-multiport[name=ReqLimit, port="http,https", protocol=tcp]
logpath = /opt/1panel/apps/openresty/openresty/logs/*error.log
         /usr/local/openresty/nginx/logs/*error.log
maxretry = 5
findtime = 60
bantime = 1800

# ========== OpenResty æ¶æ„æ‰«æ ==========
[openresty-badbots]
enabled = true
filter = nginx-badbots
action = iptables-multiport[name=BadBots, port="http,https", protocol=tcp]
logpath = /opt/1panel/apps/openresty/openresty/logs/*access.log
         /usr/local/openresty/nginx/logs/*access.log
maxretry = 2
findtime = 600
bantime = 86400

# ========== OpenResty 404 æ‰«æ ==========
[openresty-noscript]
enabled = true
filter = nginx-noscript
action = iptables-multiport[name=NoScript, port="http,https", protocol=tcp]
logpath = /opt/1panel/apps/openresty/openresty/logs/*access.log
         /usr/local/openresty/nginx/logs/*access.log
maxretry = 3
findtime = 300
bantime = 7200

# ========== SSH ä¿æŠ¤ ==========
[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
findtime = 300
bantime = 3600
```

### 2.3 åˆ›å»ºè‡ªå®šä¹‰è¿‡æ»¤å™¨

åœ¨ 1Panel ä¸­:
```
åº”ç”¨ â†’ Fail2ban â†’ é…ç½®ç¼–è¾‘ â†’ filter.d/nginx-req-limit.conf
```

```ini
[Definition]
failregex = limiting requests, excess:.* by zone.*client: <HOST>
            limiting requests, exceed.* by zone.*client: <HOST>
            [error] \d+#\d+: \*\d+ limiting requests.*client: <HOST>
ignoreregex =
```

### 2.4 é‡å¯å¹¶éªŒè¯

```
åº”ç”¨ â†’ Fail2ban â†’ é‡å¯
```

æˆ–åœ¨ç»ˆç«¯æ‰§è¡Œ:
```bash
# æŸ¥çœ‹çŠ¶æ€
fail2ban-client status

# æŸ¥çœ‹ç‰¹å®š jail çŠ¶æ€
fail2ban-client status openresty-req-limit

# è§£å° IP
fail2ban-client set openresty-req-limit unbanip 1.2.3.4
```

---

## ä¸‰ã€OpenResty é™æµé…ç½®ï¼ˆé€šè¿‡ 1Panel ç¼–è¾‘ï¼‰

### 3.1 é€šè¿‡ 1Panel ç¼–è¾‘ nginx é…ç½®

```
1Panel â†’ ç½‘ç«™ â†’ é€‰æ‹©ç½‘ç«™ â†’ é…ç½®æ–‡ä»¶
```

æ‰¾åˆ° `http` å—ï¼Œæ·»åŠ é™æµé…ç½®ï¼š

```nginx
http {
    # ========== é™æµåŒºåŸŸå®šä¹‰ ==========
    # åŸºäº IP çš„é™æµï¼šæ¯ç§’ 10 ä¸ªè¯·æ±‚
    limit_req_zone $binary_remote_addr zone=general_limit:10m rate=10r/s;

    # ç™»å½•æ¥å£ä¸¥æ ¼é™æµï¼šæ¯ç§’ 3 ä¸ªè¯·æ±‚
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=3r/s;

    # å¹¶å‘è¿æ¥é™åˆ¶
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    server {
        listen 80;
        server_name example.com;

        # å…¨å±€å¹¶å‘è¿æ¥é™åˆ¶ï¼šå•IPæœ€å¤š5ä¸ªè¿æ¥
        limit_conn conn_limit 5;

        # å…¨å±€è¯·æ±‚é€Ÿç‡é™åˆ¶
        limit_req zone=general_limit burst=20 nodelay;

        # è‡ªå®šä¹‰é™æµå“åº”
        limit_req_status 429;

        # ç½‘ç«™æ ¹ç›®å½•
        root /www/wwwroot/example.com;
        index index.html index.php;

        # ç™»å½•æ¥å£ç‰¹æ®Šé™åˆ¶
        location /admin/login {
            limit_req zone=login_limit burst=5 nodelay;
            # ... å…¶ä»–é…ç½®
        }

        # API æ¥å£é™åˆ¶
        location /api/ {
            limit_req zone=login_limit burst=10 nodelay;
            # ... å…¶ä»–é…ç½®
        }

        # è‡ªå®šä¹‰ 429 å“åº”é¡µé¢
        error_page 429 /429.html;
        location = /429.html {
            return 429 '{"error": "Too many requests, please slow down"}';
            add_header Content-Type application/json;
        }
    }
}
```

### 3.2 é™æµå‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | æ¨èå€¼ |
|-----|------|-------|
| `rate` | æ¯ç§’è¯·æ±‚æ•° | æ™®é€šé¡µé¢ 10r/sï¼ŒAPI 3-5r/s |
| `burst` | çªå‘ç¼“å†²åŒº | rate çš„ 2-3 å€ |
| `nodelay` | ä¸å»¶è¿Ÿå¤„ç† burst | ç”Ÿäº§ç¯å¢ƒå¿…é¡»å¼€å¯ |
| `zone=...:10m` | å…±äº«å†…å­˜å¤§å° | 1M å¯å­˜çº¦ 1.6ä¸‡ ä¸ªIP |

### 3.3 IP é»‘åå•é…ç½®

åœ¨ `http` å—ä¸­æ·»åŠ ï¼š

```nginx
http {
    # ========== IP é»‘åå• ==========
    geo $blocked_ips {
        default 0;
        1.2.3.4 1;        # å•ä¸ª IP
        5.6.0.0/16 1;     # IP æ®µ
    }

    server {
        # é»‘åå•ç›´æ¥è¿”å› 403
        if ($blocked_ips) {
            return 403 "Your IP has been blocked";
        }

        # å…¶ä»–é…ç½®...
    }
}
```

### 3.4 User-Agent è¿‡æ»¤

```nginx
http {
    # å±è”½æ¶æ„çˆ¬è™«å’Œç©º UA
    map $http_user_agent $blocked_ua {
        default 0;
        ~*(?:curl|wget|python|scanner|hack) 1;
        ~*(?:spider|crawler|bot|scan) 1;
        "" 1;                                  # ç©º UA
        ~*^-?$ 1;                              # åªæœ‰æ¨ªçº¿
    }

    server {
        if ($blocked_ua) {
            return 403 "Forbidden User-Agent";
        }

        # å…¶ä»–é…ç½®...
    }
}
```

---

## å››ã€OpenResty Lua é«˜çº§é™æµï¼ˆæ›´å¼ºå¤§ï¼‰

### 4.1 åˆ›å»º Lua é™æµè„šæœ¬

é€šè¿‡ 1Panel æˆ–ç»ˆç«¯åˆ›å»ºæ–‡ä»¶ï¼š

```bash
# è·¯å¾„ç¤ºä¾‹
mkdir -p /opt/1panel/apps/openresty/openresty/lua
nano /opt/1panel/apps/openresty/openresty/lua/rate_limit.lua
```

```lua
-- rate_limit.lua
local redis = require "resty.redis"
local red = redis:new()

red:set_timeout(1000)

local ok, err = red:connect("127.0.0.1", 6379)
if not ok then
    ngx.log(ngx.ERR, "Redis connection failed: ", err)
    return
end

local client_ip = ngx.var.remote_addr
local key = "rate_limit:" .. client_ip

-- é€’å¢è®¡æ•°
local requests, err = red:incr(key)

if requests == 1 then
    red:expire(key, 60)  -- 60 ç§’çª—å£
end

-- é™æµï¼š1 åˆ†é’Ÿæœ€å¤š 100 æ¬¡
if requests > 100 then
    ngx.status = 429
    ngx.say("Too many requests")
    ngx.exit(429)
end
```

### 4.2 åœ¨ nginx.conf ä¸­è°ƒç”¨

```nginx
http {
    lua_shared_dict limit_counter 10m;
    lua_package_path "/opt/1panel/apps/openresty/openresty/lua/?.lua;;";

    server {
        location / {
            access_by_lua_block {
                require("rate_limit")
            }
        }
    }
}
```

---

## äº”ã€ä¸€é”®éƒ¨ç½² WAFï¼ˆæ¨èæ–¹æ¡ˆï¼‰

### 5.1 å®‰è£…é›·æ±  SafeLine WAF

```
1Panel â†’ åº”ç”¨å•†åº— â†’ æœç´¢ "é›·æ± " æˆ– "SafeLine" â†’ å®‰è£…
```

**é›·æ±  WAF åŠŸèƒ½**:
- âœ… è‡ªåŠ¨é˜²æŠ¤ SQL æ³¨å…¥ã€XSSã€CC æ”»å‡»
- âœ… å›¾å½¢åŒ–ç®¡ç†ç•Œé¢
- âœ… å®æ—¶æ”»å‡»æ—¥å¿—åˆ†æ
- âœ… ä¸€é”®å°ç¦æ¶æ„ IP

### 5.2 é…ç½® WAF ä»£ç†

å®‰è£…åï¼Œå°†ç½‘ç«™æµé‡ç»è¿‡ WAFï¼š

```nginx
server {
    listen 80;
    server_name example.com;

    # åå‘ä»£ç†åˆ° WAFï¼ˆç«¯å£æ ¹æ®å®é™…å®‰è£…è°ƒæ•´ï¼‰
    location / {
        proxy_pass http://127.0.0.1:9443;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## å…­ã€ç›‘æ§ä¸è¯Šæ–­

### 6.1 1Panel å†…ç½®ç›‘æ§

```
ç½‘ç«™ â†’ é€‰æ‹©ç½‘ç«™ â†’ ç›‘æ§
```

### 6.2 å¿«é€Ÿè¯Šæ–­å‘½ä»¤

```bash
# æŸ¥çœ‹å½“å‰è¿æ¥æœ€å¤šçš„ IP
netstat -ntu | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -nr | head -20

# æŸ¥çœ‹ OpenResty çŠ¶æ€ï¼ˆéœ€å¯ç”¨ stub_statusï¼‰
curl http://localhost/nginx_status

# å®æ—¶æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /opt/1panel/apps/openresty/openresty/logs/error.log

# æŸ¥çœ‹ Fail2ban å°ç¦çŠ¶æ€
fail2ban-client status openresty-req-limit
```

---

## ä¸ƒã€åº”æ€¥å“åº”æµç¨‹

### æ”»å‡»å¤„ç†æµç¨‹

```mermaid
graph TD
    A[å‘ç°å¼‚å¸¸] --> B{æ”»å‡»ç±»å‹?}
    B -->|DDoS| C[å¯ç”¨ CDN]
    B -->|æš´åŠ›ç ´è§£| D[åŠ å¼º Fail2ban]
    B -->|CCæ”»å‡»| E[é™ä½é™æµé˜ˆå€¼]
    C --> F[æ‰¹é‡å°ç¦ IP]
    D --> F
    E --> F
    F --> G[è§‚å¯Ÿç›‘æ§]
    G --> H[æ¢å¤æ­£å¸¸]
```

### å¿«é€Ÿåº”æ€¥æ“ä½œ

| ç´§æ€¥æƒ…å†µ | æ“ä½œ |
|---------|------|
| ç½‘ç«™è¢«åˆ· | ç¼–è¾‘ nginx é…ç½®ï¼Œé™ä½ `rate` å€¼ä¸º `1r/s` |
| æ¶æ„ IP | åœ¨ `geo $blocked_ips` ä¸­æ·»åŠ  |
| æš´åŠ›ç ´è§£ | Fail2ban é™ä½ `maxretry` ä¸º `2` |
| æµé‡æš´å¢ | å¯ç”¨ Cloudflare CDN |

### å¿«é€Ÿå‘½ä»¤

```bash
# ç«‹å³å°ç¦å•ä¸ª IP
iptables -A INPUT -s 1.2.3.4 -j DROP

# å°ç¦ IP æ®µ
iptables -A INPUT -s 1.2.3.0/24 -j DROP

# æŸ¥çœ‹å°ç¦åˆ—è¡¨
iptables -L INPUT -n -v | grep DROP

# è§£é™¤å°ç¦
iptables -D INPUT -s 1.2.3.4 -j DROP

# é‡è½½ OpenRestyï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰
openresty -s reload

# Fail2ban æ‰‹åŠ¨å°ç¦
fail2ban-client set openresty-req-limit banip 1.2.3.4

# Fail2ban è§£å°
fail2ban-client set openresty-req-limit unbanip 1.2.3.4
```

---

## å…«ã€æ¨èé…ç½®æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šå°æµé‡ç½‘ç«™ï¼ˆæ¨èï¼‰

| åŠŸèƒ½ | é…ç½®æ–¹å¼ |
|-----|---------|
| è¯·æ±‚é™æµ | nginx é…ç½® `limit_req` |
| IP é»‘åå• | nginx `geo` æ¨¡å— |
| Fail2ban | 1Panel å•†åº—å®‰è£… |
| HTTPS | 1Panel å†…ç½® Let's Encrypt |
| CDN | Cloudflare å…è´¹ç‰ˆ |

### æ–¹æ¡ˆ Bï¼šä¸­æµé‡ç½‘ç«™

| åŠŸèƒ½ | é…ç½®æ–¹å¼ |
|-----|---------|
| æ™ºèƒ½é™æµ | OpenResty + Redis Lua è„šæœ¬ |
| WAF | é›·æ±  SafeLine |
| ç›‘æ§ | 1Panel å†…ç½®ç›‘æ§ |
| CDN | é˜¿é‡Œäº‘/è…¾è®¯äº‘ CDN |

### æ–¹æ¡ˆ Cï¼šé«˜é˜²ç½‘ç«™

| åŠŸèƒ½ | é…ç½®æ–¹å¼ |
|-----|---------|
| DDoS é˜²æŠ¤ | é«˜é˜² IP / é«˜é˜² CDN |
| WAF | é›·æ± ä¼ä¸šç‰ˆ |
| ç›‘æ§ | Grafana + Prometheus |

---

## ä¹ã€é…ç½®æ£€æŸ¥æ¸…å•

### åŸºç¡€é˜²æŠ¤
- [ ] Fail2ban å·²å®‰è£…ï¼ˆ1Panel å•†åº—ï¼‰
- [ ] nginx é™æµå·²é…ç½®ï¼ˆé…ç½®æ–‡ä»¶ç¼–è¾‘ï¼‰
- [ ] SSL è¯ä¹¦å·²å¯ç”¨
- [ ] éšè—æœåŠ¡å™¨ç‰ˆæœ¬ä¿¡æ¯

### é«˜çº§é˜²æŠ¤
- [ ] Lua é™æµè„šæœ¬å·²éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰
- [ ] WAF å·²å®‰è£…ï¼ˆé›·æ±  SafeLineï¼‰
- [ ] ç›‘æ§å·²é…ç½®
- [ ] å¤‡ä»½è®¡åˆ’å·²è®¾ç½®

---

## åã€å¸¸è§é—®é¢˜

### Q1: 1Panel æ—¥å¿—è·¯å¾„åœ¨å“ªé‡Œï¼Ÿ

```bash
# 1Panel OpenResty é»˜è®¤è·¯å¾„
/opt/1panel/apps/openresty/openresty/logs/
```

### Q2: å¦‚ä½•æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼Ÿ

```bash
# æ–¹å¼ä¸€ï¼šç»ˆç«¯
tail -f /opt/1panel/apps/openresty/openresty/logs/access.log

# æ–¹å¼äºŒï¼š1Panel ç•Œé¢
ç½‘ç«™ â†’ é€‰æ‹©ç½‘ç«™ â†’ æ—¥å¿—
```

### Q3: é…ç½®ä¿®æ”¹åå¦‚ä½•ç”Ÿæ•ˆï¼Ÿ

```bash
# æ–¹å¼ä¸€ï¼š1Panel ç•Œé¢
ç½‘ç«™ â†’ é…ç½®æ–‡ä»¶ â†’ ä¿å­˜åè‡ªåŠ¨é‡è½½

# æ–¹å¼äºŒï¼šå‘½ä»¤è¡Œ
openresty -s reload
```

### Q4: å¦‚ä½•æ‰¹é‡å°ç¦ IPï¼Ÿ

åœ¨ nginx é…ç½®ä¸­ï¼š
```nginx
geo $blocked_ips {
    default 0;
    1.2.3.4 1;
    5.6.7.8 1;
    9.10.0.0/16 1;
}
```

---

## å‚è€ƒèµ„æ–™

- [1Panel å®˜æ–¹æ–‡æ¡£ - ç½‘ç«™é…ç½®](https://1panel.cn/docs/v1/user_manual/websites/website_config_basic/)
- [OpenResty å®˜æ–¹æ–‡æ¡£](https://openresty.org/cn/)
- [é›·æ±  SafeLine WAF](https://waf-ce.chaitin.cn/)
- [Fail2ban å®˜æ–¹æ–‡æ¡£](https://fail2ban.readthedocs.io/)

---

> **æœ€åæ›´æ–°**: 2026-02-09
> **é€‚ç”¨ç‰ˆæœ¬**: 1Panel v1.10+ / OpenResty 1.25+
>
> **æ›´æ­£è¯´æ˜**: 1Panel çš„"æµé‡é™åˆ¶"æ˜¯å¸¦å®½æ§åˆ¶ï¼Œä¸æ˜¯è¯·æ±‚é¢‘ç‡é™åˆ¶ã€‚è¯·æ±‚é¢‘ç‡éœ€é€šè¿‡ç¼–è¾‘ nginx é…ç½®å®ç°ã€‚
